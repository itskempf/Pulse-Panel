<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse Panel - Definitive Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { 'brand-cyan': '#0891b2', 'brand-dark': '#0f172a', 'brand-light': '#1e293b', 'brand-lighter': '#334155' } } }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .console { font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; word-wrap: break-word; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 50; justify-content: center; align-items: center; }
        .tab-button { border-bottom-width: 2px; }
        .tab-button.active { border-color: #0891b2; color: #0891b2; }
        .tab-button.inactive { border-color: transparent; color: #9ca3af; }
        .tab-content { display: none; }
        #notification-bar { transform: translateY(-150%); transition: transform 0.4s ease-in-out; }
    </style>
</head>
<body class="bg-brand-dark text-gray-200 font-sans flex h-screen overflow-hidden">

    <div id="notification-bar" class="fixed top-4 left-1/2 -translate-x-1/2 w-full max-w-md p-4 rounded-lg shadow-lg z-[100]">
        <p id="notification-message"></p>
    </div>

    <aside class="w-64 bg-brand-light p-6 flex flex-col flex-shrink-0">
        <div class="flex items-center space-x-3 mb-10"><svg class="h-10 w-10 text-brand-cyan" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><h1 class="text-2xl font-bold text-white">Pulse Panel</h1></div>
        <nav class="flex flex-col space-y-2"><a href="#" class="flex items-center space-x-3 p-3 rounded-lg bg-brand-cyan text-white font-semibold"><span>Servers</span></a></nav>
        <div class="mt-auto"><button onclick="showSettingsModal()" class="flex items-center w-full space-x-3 p-3 rounded-lg hover:bg-brand-lighter transition-colors"><span>Settings</span></button></div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold">Server Dashboard</h2>
            <button onclick="showInstallerModal()" class="bg-brand-cyan hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg"><span>Add New Server</span></button>
        </div>
        <div id="server-grid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6"></div>
    </main>

    <!-- Modals -->
    <div id="installer-modal" class="modal-backdrop"></div>
    <div id="settings-modal" class="modal-backdrop"></div>
    <div id="manage-modal" class="modal-backdrop"></div>

    <!-- Templates -->
    <template id="server-card-template">
        <div class="bg-brand-light rounded-lg shadow-lg border border-brand-lighter flex flex-col">
            <div class="p-5">
                <div class="flex justify-between items-start mb-2"><h2 class="text-xl font-semibold truncate pr-4 server-name"></h2><div class="flex items-center space-x-2 flex-shrink-0"><span class="status-light h-3 w-3 rounded-full bg-gray-500 animate-pulse"></span><span class="status-text text-sm font-medium">...</span></div></div>
                <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                    <div class="bg-brand-dark/50 p-3 rounded-md"><p class="text-gray-400 text-xs">CPU</p><p class="cpu-usage text-lg font-bold">0.00 %</p></div>
                    <div class="bg-brand-dark/50 p-3 rounded-md"><p class="text-gray-400 text-xs">Memory</p><p class="mem-usage text-lg font-bold">0.00 MB</p></div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button class="start-btn bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded-md disabled:bg-gray-600">Start</button>
                    <button class="stop-btn bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded-md disabled:bg-gray-600">Stop</button>
                    <button class="restart-btn col-span-2 bg-yellow-600 hover:bg-yellow-700 font-bold py-2 px-4 rounded-md disabled:bg-gray-600">Restart</button>
                </div>
                <div class="flex space-x-2">
                    <button class="update-btn flex-1 bg-blue-600 hover:bg-blue-700 text-sm py-2 px-4 rounded-md">Update</button>
                    <button class="manage-btn flex-1 bg-gray-600 hover:bg-gray-700 text-sm py-2 px-4 rounded-md">Manage</button>
                    <button class="delete-btn flex-1 bg-red-800 hover:bg-red-900 text-sm py-2 px-4 rounded-md">Delete</button>
                </div>
            </div>
            <div class="console-container bg-black p-4 mt-auto rounded-b-lg"><pre class="console-output bg-black h-48 overflow-y-auto"></pre><div class="mt-2 flex"><input type="text" class="command-input flex-grow bg-brand-lighter p-2 rounded-l-md" placeholder="Enter command..."><button class="send-command-btn bg-brand-cyan hover:bg-cyan-700 font-bold py-2 px-4 rounded-r-md">Send</button></div></div>
        </div>
    </template>

    <script>
    // --- App Initialization ---
    const socket = io();
    let serversData = {{ servers|tojson }};
    let gamesData = {{ games|tojson }};
    let configData = {{ config|tojson }};
    let charts = {};

    // --- Core UI Functions ---
    function showModal(id) { document.getElementById(id).style.display = 'flex'; }
    function hideModal(id) { document.getElementById(id).style.display = 'none'; }
    function showNotification(status, message) {
        const bar = document.getElementById('notification-bar'), msg = document.getElementById('notification-message');
        const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
        bar.className = `fixed top-4 left-1/2 -translate-x-1/2 w-full max-w-md p-4 rounded-lg shadow-lg z-[100] text-white ${colors[status] || 'bg-gray-700'}`;
        msg.textContent = message;
        bar.style.transform = 'translateY(0)';
        setTimeout(() => { bar.style.transform = 'translateY(-150%)'; }, 4000);
    }

    // --- Server Card Rendering & Updates ---
    function createServerCard(server) {
        const template = document.getElementById('server-card-template');
        const card = template.content.cloneNode(true).firstElementChild;
        card.id = `server-card-${server.id}`;
        card.querySelector('.server-name').textContent = server.name;
        card.querySelector('.server-name').title = server.name;
        card.querySelector('.console-output').id = `console-${server.id}`;
        
        card.querySelector('.start-btn').onclick = () => socket.emit('start_server', { id: server.id });
        card.querySelector('.stop-btn').onclick = () => socket.emit('stop_server', { id: server.id });
        card.querySelector('.restart-btn').onclick = () => socket.emit('restart_server', { id: server.id });
        card.querySelector('.update-btn').onclick = () => showUpdaterModal(server.id, server.name);
        card.querySelector('.manage-btn').onclick = () => showManageModal(server);
        card.querySelector('.delete-btn').onclick = () => {
            if (confirm(`Delete '${server.name}' from Pulse Panel?`)) {
                if (confirm(`Also permanently delete ALL server files for '${server.name}''? THIS IS IRREVERSIBLE.`)) {
                    socket.emit('delete_server', { id: server.id, delete_files: true });
                } else {
                    socket.emit('delete_server', { id: server.id, delete_files: false });
                }
            }
        };
        const commandInput = card.querySelector('.command-input');
        commandInput.onkeypress = (e) => { if (e.key === 'Enter') sendCommand(server.id, commandInput.value); };
        card.querySelector('.send-command-btn').onclick = () => sendCommand(server.id, commandInput.value);
        
        document.getElementById('server-grid').appendChild(card);
        return card;
    }

    function sendCommand(id, command) {
        if(command) {
            socket.emit('send_command', { id, command });
            document.querySelector(`#server-card-${id} .command-input`).value = '';
        }
    }

    function updateStatus(id, status, cpu, mem) {
        const card = document.getElementById(`server-card-${id}`);
        if (!card) return;
        const light = card.querySelector('.status-light'), text = card.querySelector('.status-text'),
              startBtn = card.querySelector('.start-btn'), stopBtn = card.querySelector('.stop-btn'),
              restartBtn = card.querySelector('.restart-btn');
        
        light.classList.remove('animate-pulse', 'bg-gray-500', 'bg-green-500', 'bg-red-500');
        const isOnline = status === 'online';
        light.classList.add(isOnline ? 'bg-green-500' : 'bg-red-500');
        text.textContent = isOnline ? 'Online' : 'Offline';
        text.className = `status-text text-sm font-medium ${isOnline ? 'text-green-400' : 'text-red-400'}`;
        startBtn.disabled = isOnline;
        stopBtn.disabled = !isOnline;
        restartBtn.disabled = !isOnline;
        card.querySelector('.cpu-usage').textContent = `${cpu} %`;
        card.querySelector('.mem-usage').textContent = `${mem} MB`;
    }

    // --- Socket.IO Listeners ---
    socket.on('connect', () => console.log('Pulse Panel Backend Connected!'));
    socket.on('status_update', (d) => updateStatus(d.id, d.status, d.cpu, d.mem));
    socket.on('console_output', (d) => {
        const el = document.getElementById(`console-${d.id}`);
        if(el) { el.textContent += d.data; el.scrollTop = el.scrollHeight; }
    });
    socket.on('installer_output', (d) => {
        const el = document.getElementById(`${d.context_id}-console`);
        if(el) { el.textContent += d.data; el.scrollTop = el.scrollHeight; }
    });
    socket.on('notification', (d) => showNotification(d.status, d.message));
    socket.on('server_added', (server) => {
        serversData.push(server);
        createServerCard(server);
        hideModal('installer-modal');
    });
    socket.on('server_deleted', (d) => {
        document.getElementById(`server-card-${d.id}`)?.remove();
        serversData = serversData.filter(s => s.id !== d.id);
    });

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        serversData.forEach(createServerCard);
    });

    // --- Installer Modal ---
    function showInstallerModal() {
        const modal = document.getElementById('installer-modal');
        modal.innerHTML = `
            <div class="bg-brand-light rounded-xl shadow-2xl w-full max-w-2xl border border-brand-lighter flex flex-col">
                <div class="p-6 border-b border-brand-lighter flex justify-between items-center"><h2 id="installer-title" class="text-2xl font-semibold">Install New Server</h2><button onclick="hideModal('installer-modal')" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
                <div id="installer-body-new" class="p-6 grid grid-cols-2 gap-4">
                    <select id="game-select" class="col-span-2 bg-brand-dark p-2 rounded border border-brand-lighter">${gamesData.map(g => `<option value="${g.id}">${g.name}</option>`).join('')}</select>
                    <input id="server-name" type="text" placeholder="Server Nickname (e.g., My Fun Server)" class="bg-brand-dark p-2 rounded border border-brand-lighter">
                    <input id="install-path" type="text" placeholder="Full Installation Path (e.g., C:\\Servers\\MyServer)" class="bg-brand-dark p-2 rounded border border-brand-lighter">
                    <button onclick="installServer()" class="col-span-2 bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-md">Start Installation</button>
                </div>
                <div class="bg-black p-4 rounded-b-lg"><pre id="main_installer-console" class="console bg-black h-64 overflow-y-auto"></pre></div>
            </div>`;
        showModal('installer-modal');
    }
    function installServer() {
        socket.emit('install_server', {
            game_id: document.getElementById('game-select').value,
            server_name: document.getElementById('server-name').value,
            install_path: document.getElementById('install-path').value
        });
    }
    function showUpdaterModal(id, name) {
        const modal = document.getElementById('installer-modal');
        modal.innerHTML = `
            <div class="bg-brand-light rounded-xl shadow-2xl w-full max-w-2xl border border-brand-lighter flex flex-col">
                <div class="p-6 border-b border-brand-lighter flex justify-between items-center"><h2 class="text-2xl font-semibold">Updating: ${name}</h2><button onclick="hideModal('installer-modal')" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
                <div class="bg-black p-4 rounded-b-lg"><pre id="updater_${id}-console" class="console bg-black h-64 overflow-y-auto">Preparing to update...\n</pre></div>
            </div>`;
        showModal('installer-modal');
        socket.emit('update_server', { id });
    }

    // --- Settings Modal ---
    function showSettingsModal() {
        const modal = document.getElementById('settings-modal');
        modal.innerHTML = `
            <div class="bg-brand-light rounded-xl shadow-2xl w-full max-w-4xl border border-brand-lighter flex flex-col max-h-[90vh]">
                <div class="p-6 border-b border-brand-lighter flex justify-between items-center"><h2 class="text-2xl font-semibold">Settings</h2><button onclick="hideModal('settings-modal')" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
                <div class="p-6 flex-1 overflow-y-auto space-y-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-2">SteamCMD</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <input id="steamcmd-path" type="text" placeholder="Full Path to steamcmd.exe" class="col-span-2 bg-brand-dark p-2 rounded border border-brand-lighter" value="${configData.steamcmd_path || ''}">
                            <button onclick="socket.emit('save_settings', { steamcmd_path: document.getElementById('steamcmd-path').value })" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-md">Save Path</button>
                        </div>
                    </div>
                    <div class="border-t border-brand-lighter pt-6">
                        <h3 class="text-xl font-semibold mb-2">Manage Installable Games</h3>
                        <div id="installable-games-list" class="space-y-2"></div>
                        <div class="grid grid-cols-4 gap-2 mt-4">
                            <input id="new-game-id" placeholder="Game ID (e.g., my_game)" class="bg-brand-dark p-2 rounded border border-brand-lighter">
                            <input id="new-game-name" placeholder="Display Name" class="bg-brand-dark p-2 rounded border border-brand-lighter">
                            <input id="new-game-appid" placeholder="Steam AppID" class="bg-brand-dark p-2 rounded border border-brand-lighter">
                            <button onclick="addInstallableGame()" class="bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded-md">Add Game</button>
                        </div>
                    </div>
                </div>
            </div>`;
        showModal('settings-modal');
        socket.emit('get_installable_games');
    }
    socket.on('installable_games_list', (data) => {
        gamesData = data.games;
        const listEl = document.getElementById('installable-games-list');
        if (!listEl) return;
        listEl.innerHTML = gamesData.map(game => `
            <div class="grid grid-cols-4 gap-2 items-center">
                <p>${game.id}</p><p>${game.name}</p><p>${game.appid}</p>
                <button onclick="socket.emit('delete_installable_game', { game_id: '${game.id}' })" class="bg-red-700 hover:bg-red-800 text-xs py-1 px-2 rounded">Delete</button>
            </div>`).join('');
    });
    function addInstallableGame() {
        const game = {
            id: document.getElementById('new-game-id').value,
            name: document.getElementById('new-game-name').value,
            appid: document.getElementById('new-game-appid').value
        };
        if (game.id && game.name && game.appid) {
            socket.emit('add_installable_game', { game });
            document.getElementById('new-game-id').value = '';
            document.getElementById('new-game-name').value = '';
            document.getElementById('new-game-appid').value = '';
        } else {
            showNotification('error', 'All game fields are required.');
        }
    }
    socket.on('config_updated', (d) => { configData = d; hideModal('settings-modal'); });

    // --- Manage Modal ---
    function showManageModal(server) {
        const modal = document.getElementById('manage-modal');
        modal.innerHTML = `
        <div class="bg-brand-light rounded-xl shadow-2xl w-full max-w-7xl border border-brand-lighter flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-brand-lighter flex justify-between items-center">
                <h2 class="text-2xl font-semibold">Manage: ${server.name}</h2>
                <button onclick="hideManageModal()" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="flex-1 p-6 flex overflow-hidden">
                <!-- Left Nav -->
                <div class="w-1/5 pr-6 border-r border-brand-lighter space-y-2">
                    <button class="tab-button w-full text-left p-2 rounded active" onclick="showTab(this, 'performance')">Performance</button>
                    <button class="tab-button w-full text-left p-2 rounded inactive" onclick="showTab(this, 'console')">Console</button>
                    <button class="tab-button w-full text-left p-2 rounded inactive" onclick="showTab(this, 'startup')">Startup</button>
                    <button class="tab-button w-full text-left p-2 rounded inactive" onclick="showTab(this, 'files')">File Manager</button>
                    <button class="tab-button w-full text-left p-2 rounded inactive" onclick="showTab(this, 'schedules')">Schedules</button>
                    <button class="tab-button w-full text-left p-2 rounded inactive" onclick="showTab(this, 'backups')">Backups</button>
                </div>
                <!-- Right Content -->
                <div class="w-4/5 pl-6 overflow-y-auto">
                    <div id="tab-performance" class="tab-content" style="display:block;">
                        <h3 class="text-xl font-semibold mb-4">Real-time Performance</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><canvas id="cpu-chart"></canvas></div>
                            <div><canvas id="mem-chart"></canvas></div>
                        </div>
                    </div>
                    <div id="tab-console" class="tab-content h-full flex flex-col">
                        <pre id="manage-console-${server.id}" class="console bg-black h-full flex-1 p-2 rounded-md border border-brand-lighter overflow-y-auto"></pre>
                    </div>
                    <div id="tab-startup" class="tab-content">
                         <h3 class="text-xl font-semibold mb-4">Startup Command</h3>
                         <textarea id="manage-start-command" rows="8" class="console w-full bg-black p-2 rounded-md border border-brand-lighter">${server.start_command}</textarea>
                         <button onclick="saveServerConfig('${server.id}')" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-md">Save Start Command</button>
                    </div>
                    <div id="tab-files" class="tab-content"></div>
                    <div id="tab-schedules" class="tab-content"></div>
                    <div id="tab-backups" class="tab-content"></div>
                </div>
            </div>
        </div>`;
        showModal('manage-modal');
        // Initial tab load
        loadPerformanceTab(server.id);
    }

    function hideManageModal() {
        Object.values(charts).forEach(chart => chart.destroy());
        charts = {};
        hideModal('manage-modal');
    }

    function showTab(btn, tabName) {
        document.querySelectorAll('#manage-modal .tab-button').forEach(b => b.classList.replace('active', 'inactive'));
        btn.classList.replace('inactive', 'active');
        document.querySelectorAll('#manage-modal .tab-content').forEach(c => c.style.display = 'none');
        document.getElementById(`tab-${tabName}`).style.display = 'block';

        const serverId = document.querySelector('#manage-modal h2').textContent.split(': ')[1];
        const server = serversData.find(s => s.name === serverId);

        if (tabName === 'performance') loadPerformanceTab(server.id);
        if (tabName === 'schedules') loadSchedulesTab(server.id);
        if (tabName === 'backups') loadBackupsTab(server.id);
    }

    function saveServerConfig(id) {
        socket.emit('save_server_config', { id, start_command: document.getElementById('manage-start-command').value });
    }

    // --- Manage Modal: Performance Tab ---
    function loadPerformanceTab(id) {
        const cpuCtx = document.getElementById('cpu-chart').getContext('2d');
        const memCtx = document.getElementById('mem-chart').getContext('2d');
        const chartOptions = {
            scales: { y: { beginAtZero: true, suggestedMax: 100, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } },
            plugins: { legend: { labels: { color: '#9ca3af' } } },
            maintainAspectRatio: false
        };
        charts.cpu = new Chart(cpuCtx, { type: 'line', data: { labels: Array(MAX_PERF_DATA_POINTS).fill(''), datasets: [{ label: 'CPU Usage (%)', data: [], borderColor: '#34d399', tension: 0.1 }] }, options: chartOptions });
        charts.mem = new Chart(memCtx, { type: 'line', data: { labels: Array(MAX_PERF_DATA_POINTS).fill(''), datasets: [{ label: 'Memory Usage (MB)', data: [], borderColor: '#60a5fa', tension: 0.1 }] }, options: chartOptions });
        socket.emit('get_performance_history', { id });
    }
    socket.on('performance_history', (d) => {
        if(charts.cpu) charts.cpu.data.datasets[0].data = d.history.cpu; charts.cpu.update();
        if(charts.mem) charts.mem.data.datasets[0].data = d.history.mem; charts.mem.update();
    });
    socket.on('performance_update', (d) => {
        if (charts.cpu && charts.cpu.data.datasets[0].data.length > 0) {
            charts.cpu.data.datasets[0].data.push(d.cpu);
            charts.cpu.data.datasets[0].data.shift();
            charts.cpu.update('none');
        }
        if (charts.mem && charts.mem.data.datasets[0].data.length > 0) {
            charts.mem.data.datasets[0].data.push(d.mem);
            charts.mem.data.datasets[0].data.shift();
            charts.mem.update('none');
        }
    });

    // --- Manage Modal: Schedules Tab ---
    function loadSchedulesTab(id) {
        const el = document.getElementById('tab-schedules');
        el.innerHTML = `
            <h3 class="text-xl font-semibold mb-4">Task Schedules</h3>
            <div id="schedule-list" class="space-y-2 mb-6"></div>
            <div class="grid grid-cols-5 gap-2 items-center p-4 border border-brand-lighter rounded-lg">
                <select id="new-schedule-action" class="bg-brand-dark p-2 rounded border border-brand-lighter"><option value="restart">Restart</option><option value="update">Update</option><option value="backup">Backup</option></select>
                <input id="new-schedule-interval" type="number" value="1" class="bg-brand-dark p-2 rounded border border-brand-lighter">
                <select id="new-schedule-unit" class="bg-brand-dark p-2 rounded border border-brand-lighter"><option value="hours">Hours</option><option value="days">Days</option></select>
                <input id="new-schedule-at" type="text" placeholder="At Time (e.g. 04:00)" class="bg-brand-dark p-2 rounded border border-brand-lighter">
                <button onclick="addSchedule('${id}')" class="bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded-md">Add Schedule</button>
            </div>
        `;
        socket.emit('get_schedules', { id });
    }
    socket.on('schedule_list', (d) => {
        const listEl = document.getElementById('schedule-list');
        if (!listEl) return;
        listEl.innerHTML = d.schedules.map(task => `
            <div class="grid grid-cols-5 gap-2 items-center">
                <span>Action: <strong>${task.action}</strong></span>
                <span>Every: <strong>${task.interval} ${task.unit}</strong></span>
                <span class="col-span-2">At: <strong>${task.at_time || 'N/A'}</strong></span>
                <button onclick='deleteSchedule("${d.id}", ${JSON.stringify(task)})' class="bg-red-700 hover:bg-red-800 text-xs py-1 px-2 rounded">Delete</button>
            </div>
        `).join('');
    });
    function addSchedule(id) {
        socket.emit('add_schedule', {
            id,
            action: document.getElementById('new-schedule-action').value,
            interval: document.getElementById('new-schedule-interval').value,
            unit: document.getElementById('new-schedule-unit').value,
            at_time: document.getElementById('new-schedule-at').value || null
        });
    }
    function deleteSchedule(id, task) {
        socket.emit('delete_schedule', { id, task });
    }

    // --- Manage Modal: Backups Tab ---
    function loadBackupsTab(id) {
        const el = document.getElementById('tab-backups');
        el.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Backups</h3>
                <button onclick="socket.emit('create_backup', { id: '${id}' })" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-md">Create Manual Backup</button>
            </div>
            <div id="backup-list" class="space-y-2"></div>
        `;
        socket.emit('list_backups', { id });
    }
    socket.on('backup_list', (d) => {
        const listEl = document.getElementById('backup-list');
        if(!listEl) return;
        listEl.innerHTML = d.backups.map(b => `
            <div class="grid grid-cols-5 gap-4 items-center bg-brand-dark p-2 rounded">
                <span class="truncate col-span-2" title="${b.filename}">${b.filename}</span>
                <span>${b.size_mb.toFixed(2)} MB</span>
                <span>${b.created_at}</span>
                <div class="flex space-x-2">
                    <button onclick="window.location.href='/download_backup/${d.id}/${b.filename}'" class="flex-1 bg-green-600 hover:bg-green-700 text-xs py-1 px-2 rounded">Download</button>
                    <button onclick="restoreBackup('${d.id}', '${b.filename}')" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-xs py-1 px-2 rounded">Restore</button>
                    <button onclick="deleteBackup('${d.id}', '${b.filename}')" class="flex-1 bg-red-700 hover:bg-red-800 text-xs py-1 px-2 rounded">Delete</button>
                </div>
            </div>
        `).join('');
    });
    function restoreBackup(id, filename) {
        if(confirm(`This will overwrite all current server files with the backup '${filename}'. Are you sure? The server must be stopped.`)) {
            socket.emit('restore_backup', { id, filename });
        }
    }
    function deleteBackup(id, filename) {
        if(confirm(`Permanently delete the backup file '${filename}'?`)) {
            socket.emit('delete_backup', { id, filename });
        }
    }

    </script>
</body>
</html>

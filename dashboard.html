<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-cyan': '#0891b2', 'brand-dark': '#0f172a',
                        'brand-light': '#1e293b', 'brand-lighter': '#334155',
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .console { font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; word-wrap: break-word; scroll-behavior: smooth; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 50; justify-content: center; align-items: center; }
        .file-item:hover { background-color: #334155; }
        #notification-bar { transform: translateY(-100%); transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-brand-dark text-gray-200 font-sans flex h-screen overflow-hidden">

    <!-- Notification Bar -->
    <div id="notification-bar" class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-md p-4 rounded-b-lg shadow-lg z-[100]">
        <p id="notification-message"></p>
    </div>

    <!-- Sidebar -->
    <aside class="w-64 bg-brand-light p-6 flex flex-col flex-shrink-0">
        <div class="flex items-center space-x-3 mb-10">
            <svg class="h-10 w-10 text-brand-cyan" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            <h1 class="text-2xl font-bold text-white">Pulse Panel</h1>
        </div>
        <nav class="flex flex-col space-y-2">
            <a href="#" class="flex items-center space-x-3 p-3 rounded-lg bg-brand-cyan text-white font-semibold">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/></svg>
                <span>Servers</span>
            </a>
        </nav>
        <div class="mt-auto">
             <button onclick="showModal('settings-modal')" class="flex items-center w-full space-x-3 p-3 rounded-lg hover:bg-brand-lighter transition-colors">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span>Settings</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8 overflow-y-auto">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold">Server Dashboard</h2>
            <button onclick="showInstallerModal('main_installer')" class="bg-brand-cyan hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                <span>Add New Server</span>
            </button>
        </div>
        <div id="server-grid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
            {{ servers|tojson }}
        </div>
    </main>

    <!-- Modals -->
    <div id="installer-modal" class="modal-backdrop">
        <!-- Unchanged from previous version -->
    </div>
    <div id="settings-modal" class="modal-backdrop">
        <!-- Unchanged from previous version -->
    </div>
    <div id="manage-modal" class="modal-backdrop">
        <div class="bg-brand-light rounded-xl shadow-2xl w-full max-w-6xl border border-brand-lighter flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-brand-lighter flex justify-between items-center">
                <h2 id="manage-modal-title" class="text-2xl font-semibold">Manage Server</h2>
                <button onclick="hideModal('manage-modal')" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="flex-1 p-6 grid grid-cols-3 gap-6 overflow-hidden">
                <div class="col-span-1 flex flex-col space-y-4">
                    <div class="flex border-b border-brand-lighter">
                        <button id="tab-start-command" onclick="showTab('start-command')" class="flex-1 py-2 text-center font-semibold border-b-2 border-brand-cyan">Start Command</button>
                        <button id="tab-file-browser" onclick="showTab('file-browser')" class="flex-1 py-2 text-center text-gray-400 border-b-2 border-transparent">File Browser</button>
                    </div>
                    <div id="view-start-command">
                        <p class="text-sm text-gray-400 mb-2">Command to execute when 'Start' is clicked.</p>
                        <textarea id="manage-start-command" rows="8" class="console w-full bg-black p-2 rounded-md border border-brand-lighter"></textarea>
                        <button onclick="saveServerConfig()" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-md">Save Start Command</button>
                    </div>
                    <div id="view-file-browser" class="hidden flex-1 flex flex-col overflow-hidden">
                        <div id="file-path-breadcrumbs" class="text-sm text-gray-400 mb-2 truncate">/</div>
                        <div class="flex space-x-2 mb-2">
                            <button onclick="promptCreateItem('folder')" class="flex-1 text-sm bg-brand-lighter hover:bg-brand-cyan py-2 rounded">New Folder</button>
                            <button onclick="promptCreateItem('file')" class="flex-1 text-sm bg-brand-lighter hover:bg-brand-cyan py-2 rounded">New File</button>
                        </div>
                        <div id="file-list" class="flex-1 overflow-y-auto bg-brand-dark p-2 rounded-md border border-brand-lighter"></div>
                    </div>
                </div>
                <div class="col-span-2 flex flex-col overflow-hidden">
                    <div id="editor-view" class="hidden flex-1 flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                           <h3 id="editing-file-name" class="font-semibold text-lg truncate"></h3>
                           <button onclick="saveFileContent()" class="bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded-md">Save File</button>
                        </div>
                        <textarea id="file-editor" class="console w-full flex-1 bg-black p-4 rounded-md border border-brand-lighter"></textarea>
                    </div>
                    <div id="editor-placeholder" class="flex-1 flex items-center justify-center bg-brand-dark rounded-md border-2 border-dashed border-brand-lighter">
                        <p class="text-gray-500">Select a file to edit</p>
                    </div>
                </div>
            </div>
             <input type="hidden" id="manage-server-id">
             <input type="hidden" id="current-browser-path">
             <input type="hidden" id="current-file-path">
        </div>
    </div>

    <!-- Jinja2 Macro for Server Card -->
    {% macro server_card(server) %}
    <div id="server-card-{{ server.id }}" class="bg-brand-light rounded-lg shadow-lg border border-brand-lighter flex flex-col">
        <div class="p-5">
            <div class="flex justify-between items-start mb-2"><h2 class="text-xl font-semibold truncate pr-4" title="{{ server.name }}">{{ server.name }}</h2><div class="flex items-center space-x-2 flex-shrink-0"><span id="status-light-{{ server.id }}" class="h-3 w-3 rounded-full bg-gray-500 animate-pulse"></span><span id="status-text-{{ server.id }}" class="text-sm font-medium">...</span></div></div>
            <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                <div class="bg-brand-dark/50 p-3 rounded-md"><p class="text-gray-400 text-xs">CPU</p><p id="cpu-{{ server.id }}" class="text-lg font-bold">0.00 %</p></div>
                <div class="bg-brand-dark/50 p-3 rounded-md"><p class="text-gray-400 text-xs">Memory</p><p id="mem-{{ server.id }}" class="text-lg font-bold">0.00 MB</p></div>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-3">
                <button onclick="startServer('{{ server.id }}')" id="start-btn-{{ server.id }}" class="bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded-md disabled:bg-gray-600">Start</button>
                <button onclick="stopServer('{{ server.id }}')" id="stop-btn-{{ server.id }}" class="bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded-md disabled:bg-gray-600">Stop</button>
                <button onclick="restartServer('{{ server.id }}')" id="restart-btn-{{ server.id }}" class="col-span-2 bg-yellow-600 hover:bg-yellow-700 font-bold py-2 px-4 rounded-md disabled:bg-gray-600">Restart</button>
            </div>
             <div class="flex space-x-2">
                <button onclick="updateServer('{{ server.id }}', '{{ server.name }}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-sm py-2 px-4 rounded-md">Update</button>
                <button onclick="showManageModal(`{{ server.id }}`, `{{ server.name }}`, `{{ server.start_command|replace('\n', '\\n')|replace('`', '\`') }}`)" class="flex-1 bg-gray-600 hover:bg-gray-700 text-sm py-2 px-4 rounded-md">Manage</button>
                <button onclick="deleteServer('{{ server.id }}', '{{ server.name }}')" class="flex-1 bg-red-800 hover:bg-red-900 text-sm py-2 px-4 rounded-md">Delete</button>
            </div>
        </div>
        <div class="bg-black p-4 mt-auto rounded-b-lg"><pre id="console-{{ server.id }}" class="console bg-black h-48"></pre><div class="mt-2 flex"><input type="text" id="command-{{ server.id }}" class="flex-grow bg-brand-lighter p-2 rounded-l-md" placeholder="Enter command..." onkeypress="handleCommandKeyPress(event, '{{ server.id }}')"><button onclick="sendCommand('{{ server.id }}')" class="bg-brand-cyan hover:bg-cyan-700 font-bold py-2 px-4 rounded-r-md">Send</button></div></div>
    </div>
    {% endmacro %}

    <script>
        const socket = io();
        let serversData = {{ servers|tojson }};
        
        // --- Socket Listeners ---
        socket.on('connect', () => console.log('Pulse Panel Backend Connected!'));
        socket.on('status_update', (d) => updateStatus(d.id, d.status, d.cpu, d.mem));
        socket.on('console_output', (d) => appendToConsole(`console-${d.id}`, d.data));
        socket.on('installer_output', (d) => {
            const consoleId = d.context_id.startsWith('updater_') ? document.getElementById('updater-console-template').id : `${d.context_id}-console`;
            appendToConsole(consoleId, d.data);
        });
        socket.on('config_updated', (d) => { document.getElementById('steamcmd-path').value = d.steamcmd_path; hideModal('settings-modal'); });
        socket.on('server_added', (server) => {
            serversData.push(server);
            const temp = document.createElement('div');
            const escapedCommand = server.start_command.replace(/\n/g, '\\n').replace(/`/g, '\`');
            const cardHTML = `{{ server_card(server) }}`
                .replaceAll('server.id', `"${server.id}"`).replaceAll('server.name', `"${server.name}"`)
                .replaceAll('`{{ server.start_command|replace(\'n\', \'\\n\')|replace(\'`\', \'\\`\') }}`', '`' + escapedCommand + '`');
            temp.innerHTML = cardHTML;
            document.getElementById('server-grid').appendChild(temp.firstElementChild);
        });
        socket.on('server_deleted', (d) => { document.getElementById(`server-card-${d.id}`)?.remove(); serversData = serversData.filter(s => s.id !== d.id); });
        socket.on('file_list', (d) => renderFileList(d.path, d.dirs, d.files));
        socket.on('file_content', (d) => {
            if (d.error) { showNotification('error', d.error); return; }
            document.getElementById('editor-placeholder').classList.add('hidden');
            document.getElementById('editor-view').classList.remove('hidden');
            document.getElementById('editing-file-name').textContent = d.path;
            document.getElementById('file-editor').value = d.content;
            document.getElementById('current-file-path').value = d.path;
        });
        socket.on('notification', (d) => showNotification(d.status, d.message));
        
        // --- UI Functions ---
        function showNotification(status, message) {
            const bar = document.getElementById('notification-bar');
            const msg = document.getElementById('notification-message');
            const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
            bar.className = `fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-md p-4 rounded-b-lg shadow-lg z-[100] text-white ${colors[status] || 'bg-gray-700'}`;
            msg.textContent = message;
            bar.style.transform = 'translateY(0)';
            setTimeout(() => { bar.style.transform = 'translateY(-100%)'; }, 4000);
        }
        function appendToConsole(id, text) { const el = document.getElementById(id); if (el) { el.textContent += text; el.scrollTop = el.scrollHeight; }}
        function updateStatus(id, status, cpu, mem) {
            const light = document.getElementById(`status-light-${id}`), text = document.getElementById(`status-text-${id}`), 
                  startBtn = document.getElementById(`start-btn-${id}`), stopBtn = document.getElementById(`stop-btn-${id}`),
                  restartBtn = document.getElementById(`restart-btn-${id}`);
            if (!light || !text) return;
            light.classList.remove('animate-pulse'); light.className = 'h-3 w-3 rounded-full';
            const isOnline = status === 'online';
            light.classList.add(isOnline ? 'bg-green-500' : 'bg-red-500');
            text.textContent = isOnline ? 'Online' : 'Offline';
            text.className = `text-sm font-medium ${isOnline ? 'text-green-400' : 'text-red-400'}`;
            startBtn.disabled = isOnline; stopBtn.disabled = !isOnline; restartBtn.disabled = !isOnline;
            document.getElementById(`cpu-${id}`).textContent = `${cpu} %`;
            document.getElementById(`mem-${id}`).textContent = `${mem} MB`;
        }
        function showModal(id) { document.getElementById(id).style.display = 'flex'; }
        function hideModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // --- Server Actions ---
        function startServer(id) { socket.emit('start_server', { id }); }
        function stopServer(id) { socket.emit('stop_server', { id }); }
        function restartServer(id) { socket.emit('restart_server', { id }); }
        function sendCommand(id) { const i = document.getElementById(`command-${id}`); if (i && i.value) { socket.emit('send_command', { id, command: i.value }); i.value = ''; }}
        function handleCommandKeyPress(e, id) { if (e.key === 'Enter') sendCommand(id); }
        function deleteServer(id, name) {
            if (confirm(`Delete '${name}' from Pulse Panel?`)) {
                if (confirm(`Also permanently delete ALL server files for '${name}''? THIS IS IRREVERSIBLE.`)) {
                    socket.emit('delete_server', { id: id, delete_files: true });
                } else {
                    socket.emit('delete_server', { id: id, delete_files: false });
                }
            }
        }
        
        // --- Installer/Updater Functions ---
        function showInstallerModal(context_id) {
            document.getElementById('installer-title').textContent = 'Install New Server';
            document.getElementById('installer-body-new').style.display = 'grid';
            document.getElementById('installer-body-update').style.display = 'none';
            document.getElementById(`${context_id}-console`).textContent = '';
            showModal('installer-modal');
        }
        function installServer() {
            const gameId = document.getElementById('game-select').value, serverName = document.getElementById('server-name').value, installPath = document.getElementById('install-path').value;
            if (!gameId || !serverName || !installPath) { showNotification('error', 'Please fill out all installation fields.'); return; }
            socket.emit('install_server', { game_id: gameId, server_name: serverName, install_path: installPath });
        }
        function downloadSteamCMD() {
            const path = document.getElementById('steamcmd-install-path').value;
            if (!path) { showNotification('error', 'Please provide a folder path for SteamCMD.'); return; }
            document.getElementById('settings_installer-console').textContent = '';
            socket.emit('download_steamcmd', { path: path });
        }
        function updateServer(id, name) {
            document.getElementById('installer-title').textContent = `Updating: ${name}`;
            document.getElementById('installer-body-new').style.display = 'none';
            document.getElementById('installer-body-update').style.display = 'flex';
            const consoleEl = document.getElementById('updater-console-template');
            consoleEl.id = `updater_${id}-console`;
            consoleEl.textContent = 'Preparing to update...\n';
            showModal('installer-modal');
            socket.emit('update_server', { id: id });
            document.getElementById('installer-modal').addEventListener('transitionend', () => { consoleEl.id = 'updater-console-template'; }, { once: true });
        }
        
        // --- Manage Modal & File Browser Functions ---
        function showManageModal(id, name, start_command) {
            document.getElementById('manage-modal-title').textContent = `Manage: ${name}`;
            document.getElementById('manage-server-id').value = id;
            document.getElementById('manage-start-command').value = start_command;
            showTab('start-command');
            document.getElementById('editor-view').classList.add('hidden');
            document.getElementById('editor-placeholder').classList.remove('hidden');
            showModal('manage-modal');
        }
        function saveSettings() { socket.emit('save_settings', { steamcmd_path: document.getElementById('steamcmd-path').value }); }
        function saveServerConfig() {
            const id = document.getElementById('manage-server-id').value;
            const command = document.getElementById('manage-start-command').value;
            socket.emit('save_server_config', { id: id, start_command: command });
        }
        function showTab(tabName) {
            const isStartCommand = tabName === 'start-command';
            document.getElementById('view-start-command').style.display = isStartCommand ? 'block' : 'none';
            document.getElementById('view-file-browser').style.display = isStartCommand ? 'none' : 'flex';
            document.getElementById('tab-start-command').classList.toggle('border-brand-cyan', isStartCommand);
            document.getElementById('tab-start-command').classList.toggle('text-gray-400', !isStartCommand);
            document.getElementById('tab-file-browser').classList.toggle('border-brand-cyan', !isStartCommand);
            document.getElementById('tab-file-browser').classList.toggle('text-gray-400', isStartCommand);
            if (!isStartCommand) {
                const serverId = document.getElementById('manage-server-id').value;
                socket.emit('list_files', { id: serverId, path: '' });
            }
        }
        function renderFileList(path, dirs, files) {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            document.getElementById('file-path-breadcrumbs').textContent = `/${path}`;
            document.getElementById('current-browser-path').value = path;

            if (path) {
                const parentDir = path.substring(0, path.lastIndexOf('/'));
                fileList.innerHTML += `&lt;div class="file-item p-2 cursor-pointer flex items-center" onclick="navigateFS('${parentDir}')"&gt;&lt;svg class="w-5 h-5 mr-2 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"&gt;&lt;path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"&gt;&lt;/path&gt;&lt;/svg&gt; .. (Up)&lt;/div&gt;`;
            }
            dirs.forEach(dir => {
                const newPath = path ? `${path}/${dir}` : dir;
                fileList.innerHTML += `&lt;div class="file-item p-2 cursor-pointer flex items-center" onclick="navigateFS('${newPath}')"&gt;&lt;svg class="w-5 h-5 mr-2 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"&gt;&lt;path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"&gt;&lt;/path&gt;&lt;/svg&gt;${dir}&lt;/div&gt;`;
            });
            files.forEach(file => {
                 const newPath = path ? `${path}/${file}` : file;
                fileList.innerHTML += `&lt;div class="file-item p-2 cursor-pointer flex items-center" onclick="openFile('${newPath}')"&gt;&lt;svg class="w-5 h-5 mr-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20"&gt;&lt;path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V8a2 2 0 00-2-2h-5L9 4H4zm0 2h12v8H4V6z" clip-rule="evenodd"&gt;&lt;/path&gt;&lt;/svg&gt;${file}&lt;/div&gt;`;
            });
        }
        function navigateFS(path) {
            const serverId = document.getElementById('manage-server-id').value;
            socket.emit('list_files', { id: serverId, path: path });
        }
        function openFile(path) {
            const serverId = document.getElementById('manage-server-id').value;
            socket.emit('get_file_content', { id: serverId, path: path });
        }
        function saveFileContent() {
            const serverId = document.getElementById('manage-server-id').value;
            const path = document.getElementById('current-file-path').value;
            const content = document.getElementById('file-editor').value;
            socket.emit('save_file_content', { id: serverId, path: path, content: content });
        }
        function promptCreateItem(type) {
            const name = prompt(`Enter the name for the new ${type}:`);
            if (name) {
                const serverId = document.getElementById('manage-server-id').value;
                const path = document.getElementById('current-browser-path').value;
                socket.emit('create_item', { id: serverId, path: path, type: type, name: name });
            }
        }
    </script>
</body>
</html>